---
import BaseHead from "@/components/BaseHead.astro";
import SkipLink from "@/components/SkipLink.astro";
import ThemeProvider from "@/components/ThemeProvider.astro";
import Footer from "@/components/layout/Footer.astro";
import Header from "@/components/layout/Header.astro";
import { siteConfig } from "@/site.config";
import type { SiteMeta } from "@/types";

interface Props {
	meta: SiteMeta;
}

const {
	meta: { articleDate, description = siteConfig.description, ogImage, title },
} = Astro.props;
---

<html class="scroll-smooth" lang={siteConfig.lang}>
	<head>
		<BaseHead articleDate={articleDate} description={description} ogImage={ogImage} title={title} />
		<link
			rel="stylesheet"
			href="https://cdn.jsdelivr.net/npm/katex@0.15.3/dist/katex.min.css"
		/>
		<!-- å¼•å…¥ APlayer æ ·å¼ -->
		<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/aplayer@1.10.1/dist/APlayer.min.css">
		<!-- æ·»åŠ æµè§ˆå™¨æ ‡ç­¾LOGO -->
		<link rel="icon" href="https://cdn.jsdelivr.net/gh/chnbsdan/cloudflare-workers-blog@master/themes/mya/files/hangdn.ico" type="image/x-icon">
		<link rel="shortcut icon" href="https://cdn.jsdelivr.net/gh/chnbsdan/cloudflare-workers-blog@master/themes/mya/files/hangdn.ico" type="image/x-icon">
	</head>

	<body
		class="mx-auto flex min-h-screen max-w-6xl flex-col bg-bgColor px-4 pt-16 font-mono text-sm font-normal text-textColor antialiased sm:px-8"
	>
		<!-- èƒŒæ™¯è½®æ’­å®¹å™¨ -->
		<div class="background-container">
			<img src="https://webp.hangdn.com/fg/fg1.jpg" class="background-slide active" alt="bg1">
			<img src="https://webp.hangdn.com/fg/fg2.jpg" class="background-slide" alt="bg2">
			<img src="https://webp.hangdn.com/fg/yk5.jpg" class="background-slide" alt="bg3">
			<img src="https://pan.hangdn.com/raw/img/352347587.jpg" class="background-slide" alt="bg4">
			<img src="https://pan.hangdn.com/raw/img/377786273.jpg" class="background-slide" alt="bg5">
			<img src="https://webp.hangdn.com/fg/fj22.jpg" class="background-slide" alt="bg6">
			<img src="https://webp.hangdn.com/fg/yk1.jpg" class="background-slide" alt="bg7">
			<img src="https://webp.hangdn.com/fg/yk2.jpg" class="background-slide" alt="bg8">
			<img src="https://webp.hangdn.com/fg/yk3.jpg" class="background-slide" alt="bg9">
			<img src="https://webp.hangdn.com/fg/sh3.jpg" class="background-slide" alt="bg10">
			<img src="https://webp.hangdn.com/fg/sh2.jpg" class="background-slide" alt="bg11">
			<img src="https://webp.hangdn.com/fg/sh1.jpg" class="background-slide" alt="bg12">
			<img src="https://webp.hangdn.com/fg/bj1.jpg" class="background-slide" alt="bg13">
		</div>

		<!-- é»‘è‰²é®ç½©å±‚ -->
		<div class="bg-overlay"></div>

		<!-- ç‹¬ç«‹æ­Œè¯æ˜¾ç¤º -->
		<div id="floating-lyrics">
			<div class="current-line"></div>
			<div class="next-line"></div>
		</div>

		<!-- éŸ³ä¹èƒ¶å›Š -->
		<div id="music-capsule" title="ç‚¹å‡»å±•å¼€éŸ³ä¹æ’­æ”¾å™¨">
			<img id="capsule-cover" src="https://p2.music.126.net/4HGEnXVexEfF2M4WdDdfrQ==/109951166354363385.jpg" alt="capsule cover">
			<!-- é»‘èƒ¶å”±ç‰‡æ»‘åŠ¨æ† -->
			<div class="vinyl-arm">
				<div class="arm-base"></div>
				<div class="arm-rod"></div>
				<div class="arm-head"></div>
			</div>
		</div>

		<!-- æ’­æ”¾å™¨å®¹å™¨ -->
		<div id="player-wrap" aria-hidden="true">
			<div id="aplayer-container"></div>
		</div>

		<!-- å³é”®èœå• -->
		<ul id="right-menu" role="menu" aria-hidden="true">
			<li id="menu-play">â–¶ æ’­æ”¾ / æš‚åœ</li>
			<li id="menu-prev">â® ä¸Šä¸€é¦–</li>
			<li id="menu-next">â­ ä¸‹ä¸€é¦–</li>
			<li id="menu-volup">ğŸ”Š éŸ³é‡ +</li>
			<li id="menu-voldown">ğŸ”‰ éŸ³é‡ -</li>
			<li id="menu-lyrics">ğŸ“œ æ˜¾ç¤º/éšè—æ­Œè¯</li>
			<li id="menu-support">ğŸ’¡ æŠ€æœ¯æ”¯æŒ</li>
			<li id="menu-fullscreen">ğŸ–¥ï¸ å…¨å±æ¨¡å¼</li>
			<li id="menu-close">âŒ å…³é—­æ’­æ”¾å™¨</li>
		</ul>

		<!-- æ¯›ç»ç’ƒå¯¼èˆªæ  -->
		<div class="glass-navbar">
			<ThemeProvider />
			<SkipLink />
			<Header />
		</div>

		<!-- ä¸»è¦å†…å®¹åŒºåŸŸ - ä¿æŒåŸæœ‰ç»“æ„ -->
		<div class="main-content">
			<main id="main">
				<slot />
			</main>
			<Footer />
		</div>

		<style is:global>
			/* å®‰çŸ¥é±¼é£æ ¼çš„æ¯›ç»ç’ƒå¯¼èˆªæ  */
			.glass-navbar {
				position: fixed;
				top: 0;
				left: 0;
				width: 100%;
				z-index: 100;
				background: rgba(255, 255, 255, 0.1);
				backdrop-filter: blur(10px) saturate(180%);
				-webkit-backdrop-filter: blur(10px) saturate(180%);
				border-bottom: 1px solid rgba(255, 255, 255, 0.1);
			}

			/* ä¸»è¦å†…å®¹åŒºåŸŸ - æ¯›ç»ç’ƒæ•ˆæœ */
			.main-content {
				margin-top: 80px;
				background: rgba(255, 255, 255, 0.05);
				backdrop-filter: blur(10px) saturate(180%);
				-webkit-backdrop-filter: blur(10px) saturate(180%);
				border-radius: 12px;
				border: 1px solid rgba(255, 255, 255, 0.1);
				margin-left: auto;
				margin-right: auto;
				width: 100%;
			}

			/* èƒŒæ™¯è½®æ’­æ ·å¼ */
			.background-container {
				position: fixed;
				top: 0;
				left: 0;
				width: 100%;
				height: 100%;
				z-index: -2;
				overflow: hidden;
			}
			
			.background-slide {
				position: absolute;
				top: 0;
				left: 0;
				width: 100%;
				height: 100%;
				object-fit: cover;
				opacity: 0;
				transition: opacity 1.5s ease-in-out;
				filter: brightness(0.4);
			}
			
			.background-slide.active {
				opacity: 1;
			}
			
			/* é»‘è‰²é®ç½©å±‚ 
			.bg-overlay {
				position: fixed;
				top: 0;
				left: 0;
				width: 100%;
				height: 100%;
				background: rgba(0,0,0,0.3);
				z-index: -1;
				pointer-events: none;
			}*/

			/* éŸ³ä¹æ’­æ”¾å™¨ç›¸å…³æ ·å¼ */
			#player-wrap {
				position: fixed;
				left: 18px;
				top: 50%;
				transform: translateY(-50%);
				width: 360px;
				max-width: calc(100% - 36px);
				z-index: 15000;
				display: none;
			}
			#player-wrap.show {
				display: block;
				animation: popIn .18s ease;
			}
			@keyframes popIn {
				from { opacity: 0; transform: translateY(-50%) scale(.96) }
				to { opacity: 1; transform: translateY(-50%) scale(1) }
			}

			/* APlayer æ ·å¼ */
			.aplayer { 
				border-radius: 12px !important; 
				background: rgba(255, 255, 255, 0.95) !important;
				backdrop-filter: blur(10px) !important;
			}

			/* ç‹¬ç«‹æ­Œè¯æ˜¾ç¤º */
			#floating-lyrics {
				position: fixed;
				left: 100px;
				bottom: 50px;
				text-align: left;
				z-index: 99999;
				color: #ff8c00;
				font-size: 18px;
				font-weight: bold;
				text-shadow: 2px 2px 12px rgba(0, 0, 0, 0.9);
				background: rgba(255, 255, 255, 0.15);
				padding: 15px 20px;
				border-radius: 12px;
				backdrop-filter: blur(20px) saturate(180%);
				-webkit-backdrop-filter: blur(20px) saturate(180%);
				max-width: 400px;
				opacity: 0;
				transition: opacity 0.3s ease;
				border: 1px solid rgba(255, 255, 255, 0.15);
				pointer-events: none;
			}

			#floating-lyrics.show {
				opacity: 1;
			}

			#floating-lyrics .current-line {
				color: #ff4500;
				font-size: 30px;
				margin-bottom: 8px;
				font-weight: bold;
			}

			#floating-lyrics .next-line {
				color: #ff8c00;
				font-size: 14px;
				opacity: 0.8;
			}

			/* éŸ³ä¹èƒ¶å›Š */
			#music-capsule {
				position: fixed;
				left: 22px;
				bottom: 96px;
				width: 72px;
				height: 72px;
				border-radius: 50%;
				display: flex;
				align-items: center;
				justify-content: center;
				cursor: pointer;
				z-index: 30000;
				background: radial-gradient(circle at 30% 30%, #00c3ff, #0061ff);
				box-shadow: 0 8px 28px rgba(0, 180, 255, 0.12);
			}
			#music-capsule img {
				width: 64%;
				height: 64%;
				border-radius: 50%;
				object-fit: cover;
				transition: transform .3s;
			}
			#music-capsule.playing {
				background: radial-gradient(circle at 30% 30%, #ff9500, #ff5e00);
				box-shadow: 0 8px 28px rgba(255, 140, 0, 0.28);
			}
			#music-capsule.playing img {
				animation: spin 6s linear infinite;
			}
			@keyframes spin {
				from { transform: rotate(0) }
				to { transform: rotate(360deg) }
			}

			/* å³é”®èœå• */
			#right-menu {
				position: fixed;
				display: none;
				z-index: 40000;
				min-width: 220px;
				background: rgba(255, 255, 255, 0.15);
				backdrop-filter: blur(15px);
				-webkit-backdrop-filter: blur(15px);
				color: #fff;
				border-radius: 12px;
				box-shadow: 0 15px 35px rgba(0, 0, 0, 0.4);
				padding: 8px 0;
				opacity: 0;
				transform: scale(.98);
				transition: opacity .12s, transform .12s;
				border: 1px solid rgba(255, 255, 255, 0.15);
			}
			#right-menu.show {
				display: flex;
				opacity: 1;
				transform: scale(1);
				flex-direction: column;
			}
			#right-menu li {
				list-style: none;
				padding: 12px 18px;
				cursor: pointer;
				white-space: nowrap;
				font-weight: 700;
				transition: all .12s;
				font-size: 0.9rem;
			}
			#right-menu li:hover {
				background: rgba(255, 255, 255, 0.2);
				color: #f97316;
				border-radius: 6px;
			}

			/* å“åº”å¼è®¾è®¡ */
			@media (max-width: 900px) {
				.main-content {
					margin-top: 70px;
					border-radius: 8px;
				}

				.glass-navbar {
					backdrop-filter: blur(8px) saturate(160%);
					-webkit-backdrop-filter: blur(8px) saturate(160%);
				}

				#music-capsule {
					left: 18px;
					bottom: 22px;
				}
				#player-wrap {
					left: 12px;
					top: 50%;
					width: calc(100% - 24px);
				}
				#floating-lyrics {
					left: 20px;
					bottom: 30px;
					max-width: calc(100% - 40px);
					font-size: 16px;
				}
				#floating-lyrics .current-line {
					font-size: 18px;
				}
				#floating-lyrics .next-line {
					font-size: 12px;
				}
			}
		</style>

		<!-- å¼•å…¥ APlayer å’Œ Meting.js -->
		<script src="https://cdn.jsdelivr.net/npm/aplayer@1.10.1/dist/APlayer.min.js"></script>
		<script src="https://unpkg.com/meting@2.0.1/dist/Meting.min.js"></script>

		<script>
			// éŸ³ä¹æ’­æ”¾å™¨é…ç½®
			const PLAYLIST_ID = '14148542684';

			// DOM å¼•ç”¨
			const capsule = document.getElementById('music-capsule');
			const capsuleCover = document.getElementById('capsule-cover');
			const playerWrap = document.getElementById('player-wrap');
			const aplayerContainer = document.getElementById('aplayer-container');
			const rightMenu = document.getElementById('right-menu');

			let metingEl = null;
			let aplayer = null;
			let lyricsInterval = null;
			let currentLyric = '';
			let lyricsVisible = true;

			// ç‹¬ç«‹æ­Œè¯æ˜¾ç¤ºåŠŸèƒ½
			const floatingLyrics = document.getElementById('floating-lyrics');
			const currentLineEl = floatingLyrics.querySelector('.current-line');
			const nextLineEl = floatingLyrics.querySelector('.next-line');

			// åˆå§‹åŒ–éŸ³ä¹æ’­æ”¾å™¨
			function initMusicPlayer() {
				aplayerContainer.innerHTML = '';
				
				metingEl = document.createElement('meting-js');
				metingEl.setAttribute('server', 'netease');
				metingEl.setAttribute('type', 'playlist');
				metingEl.setAttribute('id', PLAYLIST_ID);
				metingEl.setAttribute('autoplay', 'false');
				metingEl.setAttribute('theme', '#49b1f5');
				metingEl.setAttribute('loop', 'all');
				metingEl.setAttribute('preload', 'auto');
				metingEl.setAttribute('lrctype', '1');
				metingEl.setAttribute('mutex', 'true');
				metingEl.setAttribute('list-max-height', '340px');
				
				aplayerContainer.appendChild(metingEl);

				metingEl.addEventListener('rendered', function() {
					if (metingEl.aplayer) {
						aplayer = metingEl.aplayer;
						bindAPlayerEvents(aplayer);
					}
				});

				let checkCount = 0;
				const checkInterval = setInterval(() => {
					if (metingEl.aplayer) {
						clearInterval(checkInterval);
						aplayer = metingEl.aplayer;
						bindAPlayerEvents(aplayer);
					} else if (checkCount > 30) {
						clearInterval(checkInterval);
					}
					checkCount++;
				}, 300);
			}

			// ç»‘å®š APlayer äº‹ä»¶
			function bindAPlayerEvents(ap) {
				if (!ap) return;

				function updateCover() {
					try {
						const info = ap.list.audios[ap.list.index];
						if (info && info.cover) {
							capsuleCover.src = info.cover;
						}
					} catch(e) {}
				}

				ap.on('loadeddata', updateCover);
				ap.on('listswitch', updateCover);
				ap.on('play', ()=> {
					capsule.classList.add('playing');
					startLyricsUpdate(ap);
				});
				ap.on('pause', ()=> {
					capsule.classList.remove('playing');
					floatingLyrics.classList.remove('show');
					currentLyric = '';
				});
				ap.on('ended', ()=> {
					floatingLyrics.classList.remove('show');
					currentLyric = '';
				});

				updateCover();
			}

			// æ­Œè¯åŠŸèƒ½
			function startLyricsUpdate(ap) {
				if (lyricsInterval) {
					clearInterval(lyricsInterval);
				}
				
				lyricsInterval = setInterval(() => {
					updateLyricsFromDOM();
				}, 100);
			}

			function updateLyricsFromDOM() {
				try {
					if (!lyricsVisible) return;
					
					const lrcContainer = document.querySelector('.aplayer-lrc');
					if (!lrcContainer) {
						floatingLyrics.classList.remove('show');
						return;
					}
					
					const currentLrc = lrcContainer.querySelector('p.aplayer-lrc-current');
					const allLrcLines = lrcContainer.querySelectorAll('p');
					
					if (currentLrc && currentLrc.textContent.trim()) {
						const currentText = currentLrc.textContent.trim();
						let nextText = '';
						
						for (let i = 0; i < allLrcLines.length; i++) {
							if (allLrcLines[i] === currentLrc && i < allLrcLines.length - 1) {
								nextText = allLrcLines[i + 1].textContent.trim();
								break;
							}
						}
						
						currentLineEl.textContent = currentText;
						nextLineEl.textContent = nextText;
						floatingLyrics.classList.add('show');
					} else {
						floatingLyrics.classList.remove('show');
						currentLyric = '';
					}
				} catch (error) {
					floatingLyrics.classList.remove('show');
					currentLyric = '';
				}
			}

			// èƒ¶å›Šç‚¹å‡»äº‹ä»¶
			capsule.addEventListener('click', ()=>{
				capsule.style.display = 'none';
				playerWrap.classList.add('show');
				if (!aplayer) {
					initMusicPlayer();
				}
			});

			// å³é”®èœå•åŠŸèƒ½
			function showRightMenuAt(clientX, clientY) {
				rightMenu.style.display = 'block';
				rightMenu.classList.remove('show');
				requestAnimationFrame(()=>{
					const mw = rightMenu.offsetWidth || 220;
					const mh = rightMenu.offsetHeight || 280;
					let left = Math.round(clientX - mw/2);
					left = Math.max(8, Math.min(left, window.innerWidth - mw - 8));
					let top = clientY - mh - 12;
					if (top < 8) top = clientY + 12;
					if (top + mh > window.innerHeight - 8) top = Math.max(8, window.innerHeight - mh - 8);
					rightMenu.style.left = left + 'px';
					rightMenu.style.top = top + 'px';
					rightMenu.classList.add('show');
				});
			}

			document.addEventListener('contextmenu', (e) => {
				e.preventDefault();
				showRightMenuAt(e.clientX, e.clientY);
			});

			function hideRightMenuImmediate() {
				rightMenu.classList.remove('show');
				rightMenu.style.display = 'none';
			}

			document.addEventListener('click', (e) => {
				if (!rightMenu.contains(e.target)) hideRightMenuImmediate();
			});

			// èœå•åŠŸèƒ½ç»‘å®š
			document.getElementById('menu-play').addEventListener('click', ()=>{ 
				if (aplayer) aplayer.toggle(); 
				hideRightMenuImmediate(); 
			});
			document.getElementById('menu-prev').addEventListener('click', ()=>{ 
				if (aplayer) aplayer.skipBack(); 
				hideRightMenuImmediate(); 
			});
			document.getElementById('menu-next').addEventListener('click', ()=>{ 
				if (aplayer) aplayer.skipForward(); 
				hideRightMenuImmediate(); 
			});
			document.getElementById('menu-volup').addEventListener('click', ()=>{ 
				if (aplayer) aplayer.volume(Math.min((aplayer.audio.volume||0.8)+0.1,1), true); 
				hideRightMenuImmediate(); 
			});
			document.getElementById('menu-voldown').addEventListener('click', ()=>{ 
				if (aplayer) aplayer.volume(Math.max((aplayer.audio.volume||0.2)-0.1,0), true); 
				hideRightMenuImmediate(); 
			});
			document.getElementById('menu-lyrics').addEventListener('click', ()=>{
				lyricsVisible = !lyricsVisible;
				if (!lyricsVisible) {
					floatingLyrics.classList.remove('show');
				}
				hideRightMenuImmediate();
			});
			document.getElementById('menu-close').addEventListener('click', ()=>{
				if (aplayer) aplayer.pause();
				playerWrap.classList.remove('show');
				capsule.style.display = 'flex';
				hideRightMenuImmediate();
			});

			// é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
			document.addEventListener('DOMContentLoaded', function() {
				// é¢„åˆå§‹åŒ–éŸ³ä¹æ’­æ”¾å™¨
				initMusicPlayer();

				// èƒŒæ™¯è½®æ’­åŠŸèƒ½
				const bgImgs = document.querySelectorAll('.background-slide');
				let bgIndex = 0;
				setInterval(() => {
					bgImgs.forEach((img, i) => img.classList.toggle('active', i === bgIndex));
					bgIndex = (bgIndex + 1) % bgImgs.length;
				}, 10000);
			});
		</script>
	</body>
</html>
