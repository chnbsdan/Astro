---
import BaseHead from "@/components/BaseHead.astro";
import SkipLink from "@/components/SkipLink.astro";
import ThemeProvider from "@/components/ThemeProvider.astro";
import Footer from "@/components/layout/Footer.astro";
import Header from "@/components/layout/Header.astro";
import { siteConfig } from "@/site.config";
import type { SiteMeta } from "@/types";

interface Props {
	meta: SiteMeta;
}

const {
	meta: { articleDate, description = siteConfig.description, ogImage, title },
} = Astro.props;
---

<html class="scroll-smooth" lang={siteConfig.lang}>
	<head>
		<BaseHead articleDate={articleDate} description={description} ogImage={ogImage} title={title} />
		<link
			rel="stylesheet"
			href="https://cdn.jsdelivr.net/npm/katex@0.15.3/dist/katex.min.css"
		/>
		<!-- å¼•å…¥ APlayer æ ·å¼ -->
		<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/aplayer@1.10.1/dist/APlayer.min.css">
	</head>

	<body
		class="mx-auto flex min-h-screen max-w-4xl flex-col bg-bgColor px-4 pt-16 font-mono text-sm font-normal text-textColor antialiased sm:px-8"
	>
		<!-- èƒŒæ™¯è½®æ’­å®¹å™¨ -->
		<div class="background-container">
			<img src="https://webp.hangdn.com/fg/fg1.jpg" class="background-slide active" alt="bg1">
			<img src="https://webp.hangdn.com/fg/fg2.jpg" class="background-slide" alt="bg2">
			<img src="https://webp.hangdn.com/fg/yk5.jpg" class="background-slide" alt="bg3">
			<img src="https://pan.hangdn.com/raw/img/352347587.jpg" class="background-slide" alt="bg4">
			<img src="https://pan.hangdn.com/raw/img/377786273.jpg" class="background-slide" alt="bg5">
			<img src="https://webp.hangdn.com/fg/fj22.jpg" class="background-slide" alt="bg6">
			<img src="https://webp.hangdn.com/fg/yk1.jpg" class="background-slide" alt="bg7">
			<img src="https://webp.hangdn.com/fg/yk2.jpg" class="background-slide" alt="bg8">
			<img src="https://webp.hangdn.com/fg/yk3.jpg" class="background-slide" alt="bg9">
			<img src="https://webp.hangdn.com/fg/sh3.jpg" class="background-slide" alt="bg10">
			<img src="https://webp.hangdn.com/fg/sh2.jpg" class="background-slide" alt="bg11">
			<img src="https://webp.hangdn.com/fg/sh1.jpg" class="background-slide" alt="bg12">
			<img src="https://webp.hangdn.com/fg/bj1.jpg" class="background-slide" alt="bg13">
		</div>

		<!-- é»‘è‰²é®ç½©å±‚ -->
		<div class="bg-overlay"></div>

		<!-- ç‹¬ç«‹æ­Œè¯æ˜¾ç¤º -->
		<div id="floating-lyrics">
			<div class="current-line"></div>
			<div class="next-line"></div>
		</div>

		<!-- éŸ³ä¹èƒ¶å›Š -->
		<div id="music-capsule" title="ç‚¹å‡»å±•å¼€éŸ³ä¹æ’­æ”¾å™¨">
			<img id="capsule-cover" src="https://p2.music.126.net/4HGEnXVexEfF2M4WdDdfrQ==/109951166354363385.jpg" alt="capsule cover">
			<!-- é»‘èƒ¶å”±ç‰‡æ»‘åŠ¨æ† -->
			<div class="vinyl-arm">
				<div class="arm-base"></div>
				<div class="arm-rod"></div>
				<div class="arm-head"></div>
			</div>
		</div>

		<!-- æ’­æ”¾å™¨å®¹å™¨ -->
		<div id="player-wrap" aria-hidden="true">
			<div id="aplayer-container"></div>
		</div>

		<!-- å³é”®èœå• -->
		<ul id="right-menu" role="menu" aria-hidden="true">
			<li id="menu-play">â–¶ æ’­æ”¾ / æš‚åœ</li>
			<li id="menu-prev">â® ä¸Šä¸€é¦–</li>
			<li id="menu-next">â­ ä¸‹ä¸€é¦–</li>
			<li id="menu-volup">ğŸ”Š éŸ³é‡ +</li>
			<li id="menu-voldown">ğŸ”‰ éŸ³é‡ -</li>
			<li id="menu-lyrics">ğŸ“œ æ˜¾ç¤º/éšè—æ­Œè¯</li>
			<li id="menu-support">ğŸ’¡ æŠ€æœ¯æ”¯æŒ</li>
			<li id="menu-fullscreen">ğŸ–¥ï¸ å…¨å±æ¨¡å¼</li>
			<li id="menu-close">âŒ å…³é—­æ’­æ”¾å™¨</li>
		</ul>

		<ThemeProvider />
		<SkipLink />
		<Header />
		<main id="main">
			<slot />
		</main>
		<Footer />

		<style is:global>
			/* èƒŒæ™¯è½®æ’­æ ·å¼ */
			.background-container {
				position: fixed;
				top: 0;
				left: 0;
				width: 100%;
				height: 100%;
				z-index: -2;
				overflow: hidden;
			}
			
			.background-slide {
				position: absolute;
				top: 0;
				left: 0;
				width: 100%;
				height: 100%;
				object-fit: cover;
				opacity: 0;
				transition: opacity 1.5s ease-in-out;
				filter: brightness(0.4);
			}
			
			.background-slide.active {
				opacity: 1;
			}
			
			/* é»‘è‰²é®ç½©å±‚ */
			.bg-overlay {
				position: fixed;
				top: 0;
				left: 0;
				width: 100%;
				height: 100%;
				background: rgba(0,0,0,0.3);
				z-index: -1;
				pointer-events: none;
			}

			/* éŸ³ä¹æ’­æ”¾å™¨ç›¸å…³æ ·å¼ */
			#player-wrap {
				position: fixed;
				left: 18px;
				bottom: 92px;
				width: 360px;
				max-width: calc(100% - 36px);
				z-index: 15000;
				display: none;
				transform-origin: left bottom;
			}
			#player-wrap.show {
				display: block;
				animation: popIn .18s ease;
			}
			@keyframes popIn {
				from { opacity: 0; transform: scale(.96) }
				to { opacity: 1; transform: scale(1) }
			}

			/* APlayer æ ·å¼ä¿®å¤ */
			.aplayer { 
				border-radius: 12px !important; 
				overflow: hidden !important;
				background: rgba(255, 255, 255, 0.95) !important;
				box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3) !important;
			}

			/* ä¿®å¤ APlayer å†…éƒ¨å…ƒç´ æ ·å¼ */
			.aplayer .aplayer-info {
				border-top: none !important;
				padding: 12px 15px 8px !important;
			}

			.aplayer .aplayer-info .aplayer-music .aplayer-title {
				color: #000 !important;
				font-weight: bold !important;
			}

			.aplayer .aplayer-info .aplayer-music .aplayer-author {
				color: #666 !important;
			}

			.aplayer .aplayer-list ol li {
				color: #000 !important;
				border-top: 1px solid rgba(0, 0, 0, 0.1) !important;
			}

			.aplayer .aplayer-list ol li .aplayer-list-title {
				color: #000 !important;
			}

			.aplayer .aplayer-list ol li:hover {
				background: rgba(0, 0, 0, 0.05) !important;
			}

			.aplayer .aplayer-list ol li.aplayer-list-light {
				background: rgba(255, 140, 0, 0.1) !important;
			}

			.aplayer .aplayer-lrc p {
				color: #ff8c00 !important;
			}

			.aplayer .aplayer-lrc p.aplayer-lrc-current {
				color: #ff4500 !important;
				font-weight: bold !important;
				font-size: 16px !important;
			}

			/* ç‹¬ç«‹æ­Œè¯æ˜¾ç¤º */
			#floating-lyrics {
				position: fixed;
				left: 100px;
				bottom: 50px;
				text-align: left;
				z-index: 99999;
				color: #ff8c00;
				font-size: 18px;
				font-weight: bold;
				text-shadow: 2px 2px 12px rgba(0, 0, 0, 0.9);
				background: rgba(255, 255, 255, 0.10);
				padding: 15px 20px;
				border-radius: 12px;
				backdrop-filter: blur(20px) saturate(180%);
				-webkit-backdrop-filter: blur(20px) saturate(180%);
				max-width: 400px;
				opacity: 0;
				transition: opacity 0.3s ease;
				border: 1px solid rgba(255, 255, 255, 0.1);
				box-shadow: 
				  0 8px 32px rgba(0, 0, 0, 0.1),
				  inset 0 1px 0 rgba(255, 255, 255, 0.2);
				pointer-events: none;
			}

			#floating-lyrics.show {
				opacity: 1;
			}

			#floating-lyrics .current-line {
				color: #ff4500;
				font-size: 30px;
				margin-bottom: 8px;
				font-weight: bold;
				min-height: 24px;
				overflow: hidden;
				position: relative;
			}

			#floating-lyrics .next-line {
				color: #ff8c00;
				font-size: 14px;
				opacity: 0.8;
				min-height: 18px;
			}

			/* é€å­—æ¨è¿›æ•ˆæœ */
			#floating-lyrics .current-line .typing-text {
				display: inline-block;
				overflow: hidden;
				white-space: nowrap;
				animation: typing 2s steps(40, end), blink-caret 0.75s step-end infinite;
				border-right: 2px solid #ff4500;
				animation-fill-mode: both;
			}

			#floating-lyrics .current-line .fade-in-text {
				opacity: 0;
				animation: fadeIn 0.5s ease-in forwards;
			}

			/* æ‰“å­—æœºæ•ˆæœåŠ¨ç”» */
			@keyframes typing {
				from { width: 0 }
				to { width: 100% }
			}

			@keyframes blink-caret {
				from, to { border-color: transparent }
				50% { border-color: #ff4500 }
			}

			@keyframes fadeIn {
				from { opacity: 0; transform: translateX(20px); }
				to { opacity: 1; transform: translateX(0); }
			}

			/* éŸ³ä¹èƒ¶å›Š */
			#music-capsule {
				position: fixed;
				left: 22px;
				bottom: 96px;
				width: 72px;
				height: 72px;
				border-radius: 50%;
				display: flex;
				align-items: center;
				justify-content: center;
				cursor: pointer;
				z-index: 30000;
				background: radial-gradient(circle at 30% 30%, #00c3ff, #0061ff);
				box-shadow: 0 8px 28px rgba(0, 180, 255, 0.12);
			}
			#music-capsule img {
				width: 64%;
				height: 64%;
				border-radius: 50%;
				object-fit: cover;
				transition: transform .3s;
			}
			#music-capsule.playing {
				background: radial-gradient(circle at 30% 30%, #ff9500, #ff5e00);
				box-shadow: 0 8px 28px rgba(255, 140, 0, 0.28);
			}
			#music-capsule.playing img {
				animation: spin 6s linear infinite;
			}
			@keyframes spin {
				from { transform: rotate(0) }
				to { transform: rotate(360deg) }
			}

			/* å³é”®èœå• */
			#right-menu {
				position: fixed;
				display: none;
				z-index: 40000;
				min-width: 220px;
				background: rgba(255, 255, 255, 0.12);
				backdrop-filter: blur(10px);
				-webkit-backdrop-filter: blur(10px);
				color: #fff;
				border-radius: 10px;
				box-shadow: 0 10px 30px rgba(0, 0, 0, 0.35);
				padding: 6px 0;
				opacity: 0;
				transform: scale(.98);
				transition: opacity .12s, transform .12s;
			}
			#right-menu.show {
				display: flex;
				opacity: 1;
				transform: scale(1);
				flex-direction: column;
			}
			#right-menu li {
				list-style: none;
				padding: 10px 16px;
				cursor: pointer;
				white-space: nowrap;
				font-weight: 700;
				transition: background .12s;
			}
			#right-menu li:hover {
				background: rgba(255, 255, 255, 0.14);
				color: #f97316;
				border-radius: 6px;
			}
			#right-menu::after {
				content: "";
				position: absolute;
				top: -8px;
				left: var(--arrow-left, 24px);
				transform: translateX(-50%);
				border-left: 8px solid transparent;
				border-right: 8px solid transparent;
				border-bottom: 8px solid rgba(255, 255, 255, 0.12);
			}

			/* é»‘èƒ¶é£æ ·å¼ */
			.vinyl-arm {
				position: absolute;
				top: -30px;
				left: 50%;
				transform: translateX(-50%);
				width: 90px;
				height: 70px;
				z-index: 10;
				pointer-events: none;
				filter: drop-shadow(0 2px 4px rgba(0,0,0,0.3));
			}

			.arm-base {
				position: absolute;
				top: 0;
				left: 50%;
				transform: translateX(-50%);
				width: 16px;
				height: 25px;
				background: linear-gradient(135deg, #8b8b8b, #4a4a4a, #8b8b8b);
				border-radius: 4px 4px 2px 2px;
				box-shadow: 0 2px 8px rgba(0,0,0,0.4);
				border: 1px solid #5a5a5a;
			}

			.arm-rod {
				position: absolute;
				top: 25px;
				left: 50%;
				width: 3px;
				height: 45px;
				background: linear-gradient(to bottom, #c0c0c0, #808080, #505050);
				transform-origin: top center;
				transform: translateX(-50%) rotate(-25deg);
				transition: transform 0.8s cubic-bezier(0.34, 1.2, 0.64, 1);
				border-radius: 1px;
			}

			.arm-head {
				position: absolute;
				bottom: 0;
				left: 50%;
				width: 12px;
				height: 12px;
				background: linear-gradient(135deg, #333, #000);
				border-radius: 50%;
				transform: translateX(-50%);
				box-shadow: 0 1px 6px rgba(0,0,0,0.6), 
						inset 0 1px 1px rgba(255,255,255,0.2);
				border: 1px solid #000;
			}

			/* æ’­æ”¾çŠ¶æ€ */
			#music-capsule.playing .vinyl-arm .arm-rod {
				transform: translateX(-50%) rotate(25deg);
			}

			/* é‡‘å±å…‰æ³½ç»†èŠ‚ */
			.arm-rod::before {
				content: '';
				position: absolute;
				top: 0;
				left: 0;
				width: 100%;
				height: 100%;
				background: linear-gradient(90deg, 
					  transparent, 
					  rgba(255,255,255,0.3), 
					  transparent);
				border-radius: 1px;
			}

			/* å“åº”å¼è®¾è®¡ */
			@media (max-width: 900px) {
				#music-capsule {
					left: 18px;
					bottom: 22px;
				}
				#player-wrap {
					left: 12px;
					bottom: 84px;
					width: calc(100% - 24px);
				}
				#floating-lyrics {
					left: 90px;
					bottom: 30px;
					max-width: 250px;
					font-size: 16px;
				}
				#floating-lyrics .current-line {
					font-size: 18px;
				}
				#floating-lyrics .next-line {
					font-size: 12px;
				}
			}
		</style>

		<!-- å¼•å…¥ APlayer å’Œ Meting.js -->
		<script src="https://cdn.jsdelivr.net/npm/aplayer@1.10.1/dist/APlayer.min.js"></script>
		<script src="https://unpkg.com/meting@2.0.1/dist/Meting.min.js"></script>

		<script>
			// éŸ³ä¹æ’­æ”¾å™¨é…ç½®
			const PLAYLIST_ID = '14148542684'; // ç½‘æ˜“äº‘æ­Œå• ID

			// DOM å¼•ç”¨
			const capsule = document.getElementById('music-capsule');
			const capsuleCover = document.getElementById('capsule-cover');
			const playerWrap = document.getElementById('player-wrap');
			const aplayerContainer = document.getElementById('aplayer-container');
			const rightMenu = document.getElementById('right-menu');

			let metingEl = null;
			let aplayer = null;
			let lyricsInterval = null;
			let currentLyric = '';
			let lyricsVisible = true;

			// ç‹¬ç«‹æ­Œè¯æ˜¾ç¤ºåŠŸèƒ½
			const floatingLyrics = document.getElementById('floating-lyrics');
			const currentLineEl = floatingLyrics.querySelector('.current-line');
			const nextLineEl = floatingLyrics.querySelector('.next-line');

			// åˆå§‹åŒ–éŸ³ä¹æ’­æ”¾å™¨
			function initMusicPlayer() {
				console.log('åˆå§‹åŒ–éŸ³ä¹æ’­æ”¾å™¨...');
				
				// æ¸…ç©ºå®¹å™¨
				aplayerContainer.innerHTML = '';
				
				// åˆ›å»º meting å…ƒç´ 
				metingEl = document.createElement('meting-js');
				metingEl.setAttribute('server', 'netease');
				metingEl.setAttribute('type', 'playlist');
				metingEl.setAttribute('id', PLAYLIST_ID);
				metingEl.setAttribute('autoplay', 'false');
				metingEl.setAttribute('theme', '#49b1f5');
				metingEl.setAttribute('loop', 'all');
				metingEl.setAttribute('preload', 'auto');
				metingEl.setAttribute('lrctype', '1');
				metingEl.setAttribute('mutex', 'true');
				metingEl.setAttribute('list-max-height', '340px');
				
				aplayerContainer.appendChild(metingEl);

				// ç›‘å¬ meting æ¸²æŸ“å®Œæˆäº‹ä»¶
				metingEl.addEventListener('rendered', function() {
					console.log('Meting.js æ¸²æŸ“å®Œæˆ');
					if (metingEl.aplayer) {
						aplayer = metingEl.aplayer;
						console.log('APlayer å®ä¾‹åˆ›å»ºæˆåŠŸ', aplayer);
						bindAPlayerEvents(aplayer);
					} else {
						console.error('APlayer å®ä¾‹æœªåˆ›å»º');
					}
				});

				// å¤‡ç”¨æ–¹æ¡ˆï¼šå®šæ—¶æ£€æŸ¥
				let checkCount = 0;
				const checkInterval = setInterval(() => {
					if (metingEl.aplayer) {
						clearInterval(checkInterval);
						aplayer = metingEl.aplayer;
						console.log('é€šè¿‡å®šæ—¶å™¨è·å–åˆ° APlayer å®ä¾‹', aplayer);
						bindAPlayerEvents(aplayer);
					} else if (checkCount > 30) { // 30æ¬¡åè¶…æ—¶
						clearInterval(checkInterval);
						console.error('APlayer åˆå§‹åŒ–è¶…æ—¶');
					}
					checkCount++;
				}, 300);
			}

			// ç»‘å®š APlayer äº‹ä»¶
			function bindAPlayerEvents(ap) {
				if (!ap) {
					console.error('APlayer å®ä¾‹æ— æ•ˆ');
					return;
				}

				console.log('ç»‘å®š APlayer äº‹ä»¶');

				function updateCover() {
					try {
						const info = ap.list.audios[ap.list.index];
						if (info && info.cover) {
							capsuleCover.src = info.cover;
							console.log('æ›´æ–°å°é¢:', info.cover);
						}
					} catch(e) {
						console.error('æ›´æ–°å°é¢å¤±è´¥:', e);
					}
				}

				// ç»‘å®šäº‹ä»¶
				ap.on('loadeddata', function() {
					console.log('éŸ³ä¹æ•°æ®åŠ è½½å®Œæˆ');
					updateCover();
				});

				ap.on('listswitch', function() {
					console.log('åˆ‡æ¢æ­Œæ›²');
					updateCover();
				});

				ap.on('play', function() {
					console.log('å¼€å§‹æ’­æ”¾');
					capsule.classList.add('playing');
					startLyricsUpdate(ap);
				});

				ap.on('pause', function() {
					console.log('æš‚åœæ’­æ”¾');
					capsule.classList.remove('playing');
					floatingLyrics.classList.remove('show');
					currentLyric = '';
				});

				ap.on('ended', function() {
					console.log('æ’­æ”¾ç»“æŸ');
					floatingLyrics.classList.remove('show');
					currentLyric = '';
				});

				ap.on('error', function(e) {
					console.error('æ’­æ”¾å™¨é”™è¯¯:', e);
				});

				// åˆå§‹æ›´æ–°å°é¢
				updateCover();
			}

			// ç¡®ä¿æ’­æ”¾å™¨å°±ç»ª
			async function ensurePlayerAndRun(fn) {
				try {
					if (!aplayer) {
						console.log('APlayer æœªåˆå§‹åŒ–ï¼Œç­‰å¾…ä¸­...');
						// ç­‰å¾…ä¸€æ®µæ—¶é—´
						await new Promise(resolve => setTimeout(resolve, 500));
					}
					
					if (aplayer && typeof fn === 'function') {
						fn(aplayer);
					} else {
						console.warn('æ’­æ”¾å™¨æœªå°±ç»ªæˆ–å‡½æ•°æ— æ•ˆ');
					}
				} catch(err) {
					console.warn('æ’­æ”¾å™¨æ“ä½œå¤±è´¥:', err);
				}
			}

			// æ­Œè¯åŠŸèƒ½
			function showLyricsWithEffect(currentText, nextText) {
				if (!lyricsVisible) return;
				if (currentText === currentLyric) return;
				
				currentLyric = currentText;
				currentLineEl.innerHTML = '';
				
				if (currentText && currentText.trim()) {
					const typingSpan = document.createElement('span');
					typingSpan.className = 'typing-text';
					typingSpan.textContent = currentText;
					
					const fadeSpan = document.createElement('span');
					fadeSpan.className = 'fade-in-text';
					fadeSpan.textContent = currentText;
					
					if (currentText.length > 15) {
						currentLineEl.appendChild(fadeSpan);
					} else {
						currentLineEl.appendChild(typingSpan);
					}
					
					nextLineEl.textContent = nextText || '';
					floatingLyrics.classList.add('show');
				} else {
					floatingLyrics.classList.remove('show');
				}
			}

			function startLyricsUpdate(ap) {
				console.log('å¼€å§‹æ­Œè¯æ›´æ–°ç›‘å¬');
				
				if (lyricsInterval) {
					clearInterval(lyricsInterval);
				}
				
				lyricsInterval = setInterval(() => {
					updateLyricsFromDOM();
				}, 100);
			}

			function updateLyricsFromDOM() {
				try {
					if (!lyricsVisible) return;
					
					const lrcContainer = document.querySelector('.aplayer-lrc');
					if (!lrcContainer) {
						floatingLyrics.classList.remove('show');
						return;
					}
					
					const currentLrc = lrcContainer.querySelector('p.aplayer-lrc-current');
					const allLrcLines = lrcContainer.querySelectorAll('p');
					
					if (currentLrc && currentLrc.textContent.trim()) {
						const currentText = currentLrc.textContent.trim();
						let nextText = '';
						
						for (let i = 0; i < allLrcLines.length; i++) {
							if (allLrcLines[i] === currentLrc && i < allLrcLines.length - 1) {
								nextText = allLrcLines[i + 1].textContent.trim();
								break;
							}
						}
						
						showLyricsWithEffect(currentText, nextText);
					} else {
						floatingLyrics.classList.remove('show');
						currentLyric = '';
					}
				} catch (error) {
					console.log('æ­Œè¯æ›´æ–°é”™è¯¯:', error);
					floatingLyrics.classList.remove('show');
					currentLyric = '';
				}
			}

			// èƒ¶å›Šç‚¹å‡»äº‹ä»¶
			capsule.addEventListener('click', function() {
				console.log('ç‚¹å‡»éŸ³ä¹èƒ¶å›Š');
				capsule.style.display = 'none';
				playerWrap.classList.add('show');
				
				// å¦‚æœæ’­æ”¾å™¨è¿˜æœªåˆå§‹åŒ–ï¼Œåˆ™åˆå§‹åŒ–
				if (!aplayer) {
					initMusicPlayer();
				}
			});

			// å³é”®èœå•åŠŸèƒ½
			function showRightMenuAt(clientX, clientY) {
				rightMenu.style.display = 'block';
				rightMenu.classList.remove('show');
				requestAnimationFrame(() => {
					const mw = rightMenu.offsetWidth || 220;
					const mh = rightMenu.offsetHeight || 280;
					let left = Math.round(clientX - mw/2);
					left = Math.max(8, Math.min(left, window.innerWidth - mw - 8));
					let top = clientY - mh - 12;
					if (top < 8) top = clientY + 12;
					if (top + mh > window.innerHeight - 8) top = Math.max(8, window.innerHeight - mh - 8);
					rightMenu.style.left = left + 'px';
					rightMenu.style.top = top + 'px';
					const arrowLeft = Math.max(12, Math.min(clientX - left, mw - 12));
					rightMenu.style.setProperty('--arrow-left', arrowLeft + 'px');
					rightMenu.classList.add('show');
				});
			}

			// ç»‘å®šå³é”®äº‹ä»¶
			document.addEventListener('contextmenu', function(e) {
				e.preventDefault();
				showRightMenuAt(e.clientX, e.clientY);
			});

			function hideRightMenuImmediate() {
				rightMenu.classList.remove('show');
				rightMenu.style.display = 'none';
			}

			document.addEventListener('click', function(e) {
				if (!rightMenu.contains(e.target)) hideRightMenuImmediate();
			});

			document.addEventListener('touchstart', function(e) {
				if (!rightMenu.contains(e.target)) hideRightMenuImmediate();
			});

			// æ­Œè¯æ˜¾ç¤º/éšè—æ§åˆ¶
			function toggleLyricsVisibility() {
				lyricsVisible = !lyricsVisible;
				
				if (lyricsVisible) {
					floatingLyrics.classList.add('show');
					if (aplayer && !aplayer.audio.paused) {
						startLyricsUpdate(aplayer);
					}
				} else {
					floatingLyrics.classList.remove('show');
					currentLineEl.textContent = '';
					nextLineEl.textContent = '';
					currentLyric = '';
				}
				
				const lyricsMenuItem = document.getElementById('menu-lyrics');
				lyricsMenuItem.textContent = lyricsVisible ? 'ğŸ“œ éšè—æ­Œè¯' : 'ğŸ“œ æ˜¾ç¤ºæ­Œè¯';
				localStorage.setItem('lyricsVisible', lyricsVisible.toString());
			}

			// èœå•åŠŸèƒ½ç»‘å®š
			document.getElementById('menu-play').addEventListener('click', function() { 
				ensurePlayerAndRun(ap => ap.toggle()); 
				hideRightMenuImmediate(); 
			});

			document.getElementById('menu-prev').addEventListener('click', function() { 
				ensurePlayerAndRun(ap => ap.skipBack()); 
				hideRightMenuImmediate(); 
			});

			document.getElementById('menu-next').addEventListener('click', function() { 
				ensurePlayerAndRun(ap => ap.skipForward()); 
				hideRightMenuImmediate(); 
			});

			document.getElementById('menu-volup').addEventListener('click', function() { 
				ensurePlayerAndRun(ap => ap.volume(Math.min((ap.audio.volume || 0.8) + 0.1, 1), true)); 
				hideRightMenuImmediate(); 
			});

			document.getElementById('menu-voldown').addEventListener('click', function() { 
				ensurePlayerAndRun(ap => ap.volume(Math.max((ap.audio.volume || 0.2) - 0.1, 0), true)); 
				hideRightMenuImmediate(); 
			});

			document.getElementById('menu-lyrics').addEventListener('click', function() {
				toggleLyricsVisibility();
				hideRightMenuImmediate();
			});

			document.getElementById('menu-support').addEventListener('click', function() { 
				window.open('https://1356666.xyz', '_blank'); 
				hideRightMenuImmediate(); 
			});

			document.getElementById('menu-fullscreen').addEventListener('click', function() {
				hideRightMenuImmediate();
				if (!document.fullscreenElement) {
					document.documentElement.requestFullscreen().catch(() => {});
				} else {
					document.exitFullscreen().catch(() => {});
				}
			});

			document.getElementById('menu-close').addEventListener('click', function() {
				ensurePlayerAndRun(ap => ap.pause());
				playerWrap.classList.remove('show');
				capsule.style.display = 'flex';
				hideRightMenuImmediate();
			});

			// é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
			document.addEventListener('DOMContentLoaded', function() {
				console.log('DOM åŠ è½½å®Œæˆï¼Œåˆå§‹åŒ–éŸ³ä¹ç³»ç»Ÿ...');
				
				// åˆå§‹åŒ–æ­Œè¯æ˜¾ç¤ºçŠ¶æ€
				const savedLyricsVisible = localStorage.getItem('lyricsVisible');
				if (savedLyricsVisible !== null) {
					lyricsVisible = savedLyricsVisible === 'true';
				}
				
				const lyricsMenuItem = document.getElementById('menu-lyrics');
				lyricsMenuItem.textContent = lyricsVisible ? 'ğŸ“œ éšè—æ­Œè¯' : 'ğŸ“œ æ˜¾ç¤ºæ­Œè¯';
				
				if (!lyricsVisible) {
					floatingLyrics.classList.remove('show');
				}

				// é¢„åˆå§‹åŒ–éŸ³ä¹æ’­æ”¾å™¨ï¼ˆä½†ä¸æ˜¾ç¤ºï¼‰
				initMusicPlayer();

				// èƒŒæ™¯è½®æ’­åŠŸèƒ½
				const bgImgs = document.querySelectorAll('.background-slide');
				let bgIndex = 0;
				
				setInterval(() => {
					bgImgs.forEach((img, i) => img.classList.toggle('active', i === bgIndex));
					bgIndex = (bgIndex + 1) % bgImgs.length;
				}, 10000);
			});
		</script>
	</body>
</html>
